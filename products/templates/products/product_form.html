{% extends 'products/base.html' %} {% block content %}
  <div class="max-w-2xl mx-auto">
    <div class="mb-8">
      <h2 class="text-2xl font-semibold mb-1">Add New Product</h2>
      <p class="text-sm text-gray-500">Fill in the details below to add a new product</p>
    </div>

    <form method="POST" class="space-y-6">
      {% csrf_token %}

      <!-- Product Name -->
      <div>
        <label for="nama_produk" class="block text-sm font-medium text-gray-700 mb-2">Product Name <span class="text-red-500">*</span></label>
        <input type="text" name="nama_produk" id="nama_produk" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-gray-900 focus:border-transparent outline-none" placeholder="Enter product name" />
      </div>

      <!-- Price -->
      <div>
        <label for="harga" class="block text-sm font-medium text-gray-700 mb-2">Price (Rp) <span class="text-red-500">*</span></label>
        <input type="number" name="harga" id="harga" required min="0" step="1" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-gray-900 focus:border-transparent outline-none" placeholder="Enter price" />
        <p class="text-xs text-gray-500 mt-1">Enter numbers only</p>
      </div>

      <!-- Category -->
      <div>
        <label for="kategori" class="block text-sm font-medium text-gray-700 mb-2">Category <span class="text-red-500">*</span></label>
        <select name="kategori" id="kategori" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-gray-900 focus:border-transparent outline-none">
          <option value="">Select a category</option>
          {% for category in categories %}
            <option value="{{ category }}">{{ category }}</option>
          {% endfor %}
        </select>
      </div>

      <!-- Status -->
      <div>
        <label for="status" class="block text-sm font-medium text-gray-700 mb-2">Status <span class="text-red-500">*</span></label>
        <select name="status" id="status" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-gray-900 focus:border-transparent outline-none">
          <option value="">Select status</option>
          {% for status in status_choices %}
            <option value="{{ status }}">{{ status }}</option>
          {% endfor %}
        </select>
      </div>

      <!-- Buttons -->
      <div class="flex gap-3 pt-4">
        <button type="submit" class="flex-1 bg-gray-900 text-white px-6 py-2.5 rounded-lg hover:bg-gray-800 transition-colors">Add Product</button>
        <a href="{% url 'product_list' %}" class="flex-1 text-center border border-gray-300 px-6 py-2.5 rounded-lg hover:bg-gray-50 transition-colors">Cancel</a>
      </div>
    </form>
  </div>

  <script>
    // RESTful POST request with fetch API and JSON
    document.querySelector('form').addEventListener('submit', async function (e) {
      e.preventDefault() // Always prevent default form submission
    
      const nama = document.getElementById('nama_produk').value.trim()
      const harga = document.getElementById('harga').value
      const kategori = document.getElementById('kategori').value
      const status = document.getElementById('status').value
    
      // Client-side validation
      if (!nama) {
        alert('Product name is required')
        return
      }
    
      if (!harga || isNaN(harga) || parseFloat(harga) < 0) {
        alert('Please enter a valid price (numbers only)')
        return
      }
    
      // Prepare data as JSON
      const data = {
        nama_produk: nama,
        harga: parseFloat(harga),
        kategori: kategori,
        status: status
      }
    
      // Get CSRF token
      const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value
    
      try {
        // Send POST request to dedicated API endpoint
        const response = await fetch("{% url 'api_create_product' %}", {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken
          },
          body: JSON.stringify(data)
        })
    
        const result = await response.json()
    
        if (result.success) {
          // Show success message and redirect
          alert(result.message)
          window.location.href = "{% url 'product_list' %}"
        } else {
          // Show validation errors
          let errorMsg = 'Validation errors:\n'
          for (const [field, errors] of Object.entries(result.errors)) {
            errorMsg += `${field}: ${errors.join(', ')}\n`
          }
          alert(errorMsg)
        }
      } catch (error) {
        alert('Error adding product: ' + error.message)
      }
    })
  </script>
{% endblock %}
